<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>修改个人信息</title>
<link href="/QRCode/css/mod.css" rel="stylesheet" type="text/css">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="format-detection" content="telephone=no, email=no" />
<!--[if IE]>
    <script src="js/html5shiv.min.js"></script>
    <![endif]-->
</head>
<body style="background-color:white;">
	<header style="display:none;">
		<img onclick="window.history.go(-1)" src="/QRCode/img/rpw_back_n.png" /> <span>修改个人信息</span>
		<div class="clear"></div>
	</header>
	<section class="logo-license">
		<div class="half">
			<a class="logo" id="logox"> <img id="bgl" src="/QRCode/img/logo_n.png" />

			</a>
			<p>头像</p>
		</div>
		<div class="clear"></div>
	</section>

	<article class="htmleaf-container">
		<div id="clipArea"></div>
		<div class="foot-use">
			<div class="uploader1 blue">
				<input type="button" id="upload_file" name="file" class="button"
					value="打开" /> <input id="file" type="file"
					onchange="javascript:setImagePreview();" accept="image/*" multiple />
			</div>
			<button id="clipBtn">确认</button>
		</div>
		<div id="preview"></div>
	</article>
	<article class="info" id='_form'>
		<ul>
			<li>
				<div class="left">昵称:</div>
				<div class="right">
					<input style="background-color: white;" id="nickname" placeholder="请输入你的昵称" valid=required
						tips="请正确输入昵称!">
				</div>
				<div class="clear"></div>
			</li>
			<li>
				<div class="left">留言:</div>
				<div class="right">
					<input style="background-color: white;" id="message" placeholder="请输入你的留言" valid="required"
						tips="请正确输入留言!">
				</div>
				<div class="clear"></div>
			</li>
		</ul>

		<input type="hidden" id="openid" th:value="${openid}">
	</article>

	<article class="btn-1">
		<button not='not' onclick="success_sub();">确认提交</button>
	</article>

	<script src="/utils/js/jquery.min.js" type="text/javascript"></script>
	<script src="/utils/js/utils.js" type="text/javascript"></script>
	<script src="/utils/js/constant.js" type="text/javascript"></script>
	
	<script>
		$(function() {
			_ajax({
				url : _getUserInfo,
				data : {
					'openId' : $('#openid').val()
				},
				success : function(data) {
					$('#message').val(data.userMessage);
					$('#nickname').val(data.nickName);
					var url=data.userHeadUrl;
					if(url.indexOf('http')<0){

						$('#bgl').attr("src", _getHead+data.userHeadUrl);
					}else{
						$('#bgl').attr("src", data.userHeadUrl);
					}
				}
			})
		});
	</script>
	<script src="/QRCode/js/iscroll-zoom.js"></script>
	<script src="/QRCode/js/hammer.js"></script>
	<script src="/QRCode/js/jquery.photoClip.js"></script>
	<script>
		entity.codeBorder=false;
		var headChange=false;
		var one_obj = {
			/**
			 * @param base64Codes
			 *        图片的base64编码
			 */
			funUploadFile : function(base64Codes,callback) {
				var self = this;
				var formData = new FormData();
				//convertBase64UrlToBlob函数是将base64编码转换为Blob
				//append函数的第一个参数是后台获取数据的参数名,在php中用$FILES['imageName']接收，
				formData.append("imageName", self
						.convertBase64UrlToBlob(base64Codes));
				//ajax 提交form
				$.ajax({
					// 你后台的接收地址
					url : _uploadHead,
					//url : _uploadHeadByBlob,
					type : "POST",
					data : formData,
					dataType : "json",
					processData : false, // 告诉jQuery不要去处理发送的数据
					contentType : false, // 告诉jQuery不要去设置Content-Type请求头

					success : function(data) {
						if (data.code == "000000") {
							//return true;
							callback(data.data);
						} else {
							entity.errTips(data.data.msg || '请求异常。');
						}
					},
					xhr : function() { //在jquery函数中直接使用ajax的XMLHttpRequest对象
						var xhr = new XMLHttpRequest();

						xhr.upload.addEventListener("progress", function(evt) {
							if (evt.lengthComputable) {
								var percentComplete = Math.round(evt.loaded
										* 100 / evt.total);
								console.log("正在提交."
										+ percentComplete.toString() + '%'); //在控制台打印上传进度
							}
						}, false);

						return xhr;
					}

				});
			},
			imgDataUrl:'',
			/**
			 * 将以base64的图片url数据转换为Blob
			 * @param urlData
			 *            用url方式表示的base64图片数据
			 */
			convertBase64UrlToBlob : function(urlData) {
				//去掉url的头，并转换为byte
				var bytes = window.atob(urlData.split(',')[1]);

				//处理异常,将ascii码小于0的转换为大于0
				var ab = new ArrayBuffer(bytes.length);
				var ia = new Uint8Array(ab);
				for (var i = 0; i < bytes.length; i++) {
					ia[i] = bytes.charCodeAt(i);
				}
				// 此处type注意与photoClip初始化中的outputType类型保持一致
				return new Blob([ ab ], {
					type : 'image/jpeg'
				});
			},

			init : function() {
				var self = this;
				$("#clipArea").photoClip({
					width : 200,
					height : 200,
					file : "#file",
					view : "#view",
					ok : "#clipBtn",
					outputType : 'jpg',
					loadStart : function() {
						console.log("照片读取中");
					},
					loadComplete : function() {
						console.log("照片读取完成");
					},
					clipFinish : function(dataURL) {
						console.log('裁剪完成');
						//self.funUploadFile(dataURL);
						self.imgDataUrl=dataURL;
					}
				});
			}
		};
		one_obj.init();
		function subInfo(params){
			_ajax({
				url : _modUser,
				data : params,
				success : function(data) {
					window.location='/qrcode/my?openid='+$('#openid').val();
				}
			})
		}
		function success_sub() {
			var _vai = validateFrom('_form');
			if (_vai.res) {
				//验证通过
				if(headChange){
					//修改了图片
					//先进行图片上传；
					one_obj.funUploadFile(one_obj.imgDataUrl,function(data) {
						_vai['headName'] = data;//给头像对象赋值
						subInfo(_vai);
					})
				}else{
					subInfo(_vai);
				}
			}
		}
	</script>
</body>
</html>
